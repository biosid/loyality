Вариант 1

* Подсистема безопасности
*# добавляем в модель пользователя поле Email
*#* использования Email из профиля заменить на использование Email из безопасности
*#* если Email нет в безопасности, то используется Email из профиля - этот Email считается неподтвержденным
*# добавляем в модель пользователя количество кодов OTP, отправленных через СМС
*# добавляем таблицу токенов для смены Email
*#* токен содержит ClientId, Email, ExpirationDateTime
*# добавляем метод смены Email
*#* на вход передается токен на смену Email, OTP
*# добавляем метод отправки OTP по Email
*# дорабатываем метод восстановления пароля
*#* если есть Email, то отправляем OTP по Email
*#* если не исчерпан лимит отправки, то отправляем OTP через СМС
*#* иначе возвращаем ошибку

* Каталог
*# дорабатываем метод создания заказа
*#* проверяем лимит стоимости заказов за день и возвращаем признак необходимости OTP для подтверждения заказа

* Система оповещений
*# добавляем метод отправки письма "Подтверждение Email"

* Коннектор к банку
*# дорабатываем метод обновления данных пользователя
*#* добавить обновелние Email в безопасности

* Сайт
*# добавляем в конфигурацию опцию "Отправка OTP по подтвержденным Email"
*# дорабатываем метод получения Email пользователя
*#* если есть в безопасности, то берем оттуда - Email считается подтвержденным
*#* иначе берем из профиля - Email считается неподтвержденным
*# дорабатываем процедуру входа
*#* если Email пользователя не подтвержден, то предлагаем перейти к процедуре подтверждения
*# добавляем страницу "Для восстановления пароля необходимо обратиться в службу поддержки"
*#* показывается при отсутствии подтвержденного Email и исчерпании лимита отправки OTP через СМС
*# дорабатываем процедуру подтверждения заказа
*#* пропускаем отправку и проверку OTP, если не требуется
*#* отправляем OTP только по Email
*#* если Email пользователя не подтвержден, то перенаправляем пользователя на процедуру подтверждения
*# добавляем страницу "Подтверждение Email"
*#* на эту страницу ведет ссылка из письма для подтверждения Email
*#* при открытии страницы отправляем OTP по СМС
*#* страница содержит поле для ввода OTP и подтверждаемый Email
*#* после ввода OTP вызываем метод смены Email в безопасности и в профиле
*# добавляем страницу "Email успешно подтвержден"
*# добавляем страницу "Ошибка при подтверждении Email"
*# добавляем страницу "Смена Email"
*#* страница содержит поле для ввода нового Email
*#* при изменении Email инициируем процедуру подтверждения и показываем страницу "Для подтверждения Email перейдите по ссылке в отправленном письме"
*# удаляем со страницы "Мои данные" возможность редактирования Email
*# добавляем на страницу "Мои данные" ссылку на страницу "Смена Email"


Вариант 2 - без подтверждения Email

* Подсистема безопасности
*# Добавить в модель пользователя количество кодов OTP, отправленных через СМС
*# Добавить метод отправки OTP по Email
*# Доработать метод восстановления пароля
*#* если есть Email, то отправляем OTP по Email
*#* если не исчерпан лимит отправки, то отправляем OTP через СМС
*#* иначе возвращаем ошибку

* Каталог
*# Доработать метод создания заказа
*#* проверяем лимит стоимости заказов за день и возвращаем признак необходимости OTP для подтверждения заказа

* Сайт
*# Добавить в конфигурацию опции "Отправка OTP по Email", "Лимит отправки OTP по СМС при восстановлении пароля", "Всегда подтверждать заказ с помощью OTP", "Лимит стоимости заказов без подтверждения с помощью OTP"
*#* если опция "Отправка OTP по Email" включена, то отправлять OTP по Email
*#* если опция "Всегда подтверждать заказ с помощью OTP" не включена, то подтверждение с помощью OTP требуется только при превышении "Лимита стоимости заказов без подтверждения с помощью OTP"
*# Доработать процедуру входа
*#* если пользователь не указал Email, то предлагаем перейти в Личный кабинет и указать
*# Добавить страницу "Для восстановления пароля необходимо обратиться в службу поддержки"
*#* показывается при отсутствии Email и исчерпании лимита отправки OTP через СМС
*# Доработать процедуру создания заказа
*#* если для подтверждения заказа требуется отправка OTP по Email, то перенаправляем пользователя в Личный кабинет для ввода Email
*# Доработать процедуру подтверждения заказа
*#* пропускаем отправку и проверку OTP, если не требуется

* АРМ Администратора безопасности
*# Добавить процедуру смены Email пользователя
